!function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module){var config={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:turnserver.quickblox.com:3478?transport=udp",username:"",credential:""},{urls:"turn:turnserver.quickblox.com:3478?transport=tcp",username:"",credential:""}]};module.exports=config},{}],2:[function(require,module){function QBSignaling(chatService,params){var self=this;params&&(this._debug=params.debug||null,this._callbacks={onCallCallback:params.onCallCallback||null,onAcceptCallback:params.onAcceptCallback||null,onRejectCallback:params.onRejectCallback||null,onStopCallback:params.onStopCallback||null,onInnerAcceptCallback:null,onCandidateCallback:null}),this._onMessage=function(msg){var author,qbID,extraParams,extension={};switch(author=$(msg).attr("from"),qbID=QBChatHelpers.getIDFromNode(author),extraParams=$(stanza).find("extraParams")[0],$(extraParams.childNodes).each(function(){extension[$(this).context.tagName]=$(this).context.textContent}),extension.videochat_signaling_type){case QBSignalingType.CALL:traceS("onCall from "+qbID),self._callbacks.onCallCallback(qbID,extension);break;case QBSignalingType.ACCEPT:traceS("onAccept from "+qbID),self._callbacks.onAcceptCallback(qbID,extension),self._callbacks.onInnerAcceptCallback(extension.sdp);break;case QBSignalingType.REJECT:traceS("onReject from "+qbID),self._callbacks.onRejectCallback(qbID,extension);break;case QBSignalingType.STOP:traceS("onStop from "+qbID),self._callbacks.onStopCallback(qbID,extension);break;case QBSignalingType.CANDIDATE:self._callbacks.onCandidateCallback({sdpMLineIndex:extension.sdpMLineIndex,candidate:extension.candidate,sdpMid:extension.sdpMid});break;case QBSignalingType.PARAMETERS_CHANGED:}return!0},this._sendMessage=function(opponentID,extraParams){var reply,params;params={to:QBChatHelpers.getJID(opponentID),from:chatService._connection.jid,type:"headline"},reply=$msg(params).c("extraParams",{xmlns:Strophe.NS.CLIENT}),$(Object.keys(extraParams)).each(function(){reply.c(this).t(extraParams[this]).up()}),chatService._connection.send(reply)},chatService._connection.addHandler(self._onMessage,null,"message","headline")}function traceS(text){console.log("[qb_videochat_signalling]: "+text)}module.exports=QBSignaling;var QBSignalingType={CALL:"qbvideochat_call",ACCEPT:"qbvideochat_acceptCall",REJECT:"qbvideochat_rejectCall",STOP:"qbvideochat_stopCall",CANDIDATE:"qbvideochat_candidate",PARAMETERS_CHANGED:"qbvideochat_callParametersChanged"};QBSignaling.prototype.call=function(opponentID,sessionDescription,sessionID,extraParams){traceS("call to "+opponentID),extraParams=extraParams||{},extraParams.videochat_signaling_type=QBSignalingType.CALL,extraParams.sessionID=sessionID,extraParams.sdp=sessionDescription,extraParams.platform="web",extraParams.device_orientation="portrait",this._sendMessage(opponentID,extraParams)},QBSignaling.prototype.accept=function(opponentID,sessionDescription,sessionID,extraParams){traceS("accept "+opponentID),extraParams=extraParams||{},extraParams.videochat_signaling_type=QBSignalingType.ACCEPT,extraParams.sessionID=sessionID,extraParams.sdp=sessionDescription,extraParams.platform="web",extraParams.device_orientation="portrait",this._sendMessage(opponentID,extraParams)},QBSignaling.prototype.reject=function(opponentID,sessionID,extraParams){traceS("reject "+opponentID),extraParams=extraParams||{},extraParams.videochat_signaling_type=QBSignalingType.REJECT,extraParams.sessionID=sessionID,this._sendMessage(opponentID,extraParams)},QBSignaling.prototype.stop=function(opponentID,sessionID,extraParams){traceS("stop "+opponentID),extraParams=extraParams||{},extraParams.videochat_signaling_type=QBSignalingType.STOP,extraParams.sessionID=sessionID,this._sendMessage(opponentID,extraParams)},QBSignaling.prototype.sendCandidate=function(opponentID,candidate,sessionID){var extraParams={videochat_signaling_type:QBSignalingType.CANDIDATE,sessionID:sessionID,sdpMLineIndex:candidate.sdpMLineIndex,candidate:candidate.candidate,sdpMid:candidate.sdpMid};this._sendMessage(opponentID,extraParams)}},{}],3:[function(require){function QBVideoChat(signaling,params){var self=this;this.version="0.6.0",this.stopReason=QBStopReason,this._state=QBVideoChatState.INACTIVE,this._candidatesQueue=[],this.localStreamElement=null,this.remoteStreamElement=null,params&&(this._debug=params.debug||null,this.sessionID=params.sessionID||(new Date).getTime(),this.remoteSessionDescription=params.sessionDescription||null,this.constraints=params.constraints||null,traceVC("sessionID "+this.sessionID),this._callbacks={onGetUserMediaSuccess:params.onGetUserMediaSuccess||null,onGetUserMediaError:params.onGetUserMediaError||null}),this.onAcceptSignalingCallback=function(sessionDescription){self.setRemoteDescription(sessionDescription,"answer")},this.addCandidate=function(data){var candidate;candidate=new adapter.RTCIceCandidate(data),self.pc.addIceCandidate(candidate)},this.signaling=signaling,this.signaling._callbacks.onInnerAcceptCallback=this.onAcceptSignalingCallback,this.signaling._callbacks.onCandidateCallback=this.addCandidate,this.getUserMedia=function(){function successCallback(localMediaStream){traceVC("getUserMedia success"),self.localStream=localMediaStream,self.createRTCPeerConnection(),self._callbacks.onGetUserMediaSuccess()}function errorCallback(error){traceVC("getUserMedia error: "+JSON.stringify(error)),self._callbacks.onGetUserMediaError()}traceVC("getUserMedia..."),adapter.getUserMedia(self.constraints,successCallback,errorCallback)},this.attachMediaStream=function(elem,stream){adapter.attachMediaStream(elem,stream)},this.reattachMediaStream=function(to,from){adapter.reattachMediaStream(to,from)},this.createRTCPeerConnection=function(){traceVC("RTCPeerConnection...");try{self.pc=new adapter.RTCPeerConnection(pcConfig,PC_CONSTRAINTS),self.pc.addStream(self.localStream),self.pc.onicecandidate=self.onIceCandidateCallback,self.pc.onaddstream=self.onRemoteStreamAddedCallback,traceVC("RTCPeerConnnection created")}catch(e){traceVC("RTCPeerConnection failed: "+e.message)}},this.onIceCandidateCallback=function(event){var candidate=event.candidate;candidate&&(self._state==QBVideoChatState.INACTIVE?self._candidatesQueue.push(candidate):self.signaling.sendCandidate(self.opponentID,candidate,self.sessionID))},this.onRemoteStreamAddedCallback=function(event){traceVC("Remote stream added"),self.remoteStream=event.stream,self.attachMediaStream(self.remoteStreamElement,event.stream)},this.onGetSessionDescriptionSuccessCallback=function(sessionDescription){traceVC("LocalDescription..."),self.pc.setLocalDescription(sessionDescription,function(){traceVC("LocalDescription success"),self.localSessionDescription=sessionDescription,"offer"===sessionDescription.type?self.sendCallRequest():"answer"===sessionDescription.type&&self.sendAceptRequest()},function(error){traceVC("LocalDescription error: "+JSON.stringify(error))})},this.onCreateOfferFailureCallback=function(error){traceVC("createOffer() error: "+JSON.stringify(error))},this.setRemoteDescription=function(descriptionSDP,descriptionType){traceVC("RemoteDescription...");var sessionDescription,candidate;self._state=QBVideoChatState.ESTABLISHING,sessionDescription=new adapter.RTCSessionDescription({sdp:descriptionSDP,type:descriptionType}),self.pc.setRemoteDescription(sessionDescription,function(){traceVC("RemoteDescription success"),"offer"===sessionDescription.type&&self.pc.createAnswer(self.onGetSessionDescriptionSuccessCallback,self.onCreateAnswerFailureCallback,SDP_CONSTRAINTS)},function(error){traceVC("RemoteDescription error: "+JSON.stringify(error))});for(var i=0;i<self._candidatesQueue.length;i++)candidate=self._candidatesQueue.pop(),self.signaling.sendCandidate(self.opponentID,candidate,self.sessionID)},this.onCreateAnswerFailureCallback=function(error){traceVC("createAnswer() error: "+JSON.stringify(error))},this.sendCallRequest=function(){self.signaling.call(self.opponentID,self.localSessionDescription.sdp,self.sessionID,self.extraParams)},this.sendAceptRequest=function(){self.signaling.accept(self.opponentID,self.localSessionDescription.sdp,self.sessionID,self.extraParams)},this.hangup=function(){self._state=QBVideoChatState.INACTIVE,self.signaling=null,self.localStream.stop(),self.pc.close(),self.pc=null}}function traceVC(text){console.log("[qb_videochat]: "+text)}var adapter=require("../libs/adapter"),pcConfig=require("./config"),QBSignaling=require("./qbSignaling");window.QBSignaling=QBSignaling,window.QBVideoChat=QBVideoChat;var PC_CONSTRAINTS={optional:[]},SDP_CONSTRAINTS={optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},QBVideoChatState={INACTIVE:"inactive",ESTABLISHING:"establishing"},QBStopReason={MANUALLY:"kStopVideoChatCallStatus_Manually",BAD_CONNECTION:"kStopVideoChatCallStatus_BadConnection",CANCEL:"kStopVideoChatCallStatus_Cancel",NOT_ANSWER:"kStopVideoChatCallStatus_OpponentDidNotAnswer"};QBVideoChat.prototype.call=function(userID,extraParams){this.localSessionDescription?this.sendCallRequest():(this.opponentID=userID,this.extraParams=extraParams,this.pc.createOffer(this.onGetSessionDescriptionSuccessCallback,this.onCreateOfferFailureCallback,SDP_CONSTRAINTS))},QBVideoChat.prototype.accept=function(userID,extraParams){this.opponentID=userID,this.extraParams=extraParams,this.setRemoteDescription(this.remoteSessionDescription,"offer")},QBVideoChat.prototype.reject=function(userID,extraParams){this.signaling.reject(userID,this.sessionID,extraParams)},QBVideoChat.prototype.stop=function(userID,extraParams){this.signaling.stop(userID,this.sessionID,extraParams)}},{"../libs/adapter":4,"./config":1,"./qbSignaling":2}],4:[function(require,module){function maybeFixConfiguration(pcConfig){if(null!=pcConfig)for(var i=0;i<pcConfig.iceServers.length;i++)pcConfig.iceServers[i].hasOwnProperty("urls")&&(pcConfig.iceServers[i].url=pcConfig.iceServers[i].urls,delete pcConfig.iceServers[i].urls)}var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;if(navigator.mozGetUserMedia){webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10);var RTCPeerConnection=function(pcConfig,pcConstraints){return maybeFixConfiguration(pcConfig),new mozRTCPeerConnection(pcConfig,pcConstraints)};RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,createIceServer=function(url,username,password){var iceServer=null,url_parts=url.split(":");if(0===url_parts[0].indexOf("stun"))iceServer={url:url};else if(0===url_parts[0].indexOf("turn"))if(27>webrtcDetectedVersion){var turn_url_parts=url.split("?");(1===turn_url_parts.length||0===turn_url_parts[1].indexOf("transport=udp"))&&(iceServer={url:turn_url_parts[0],credential:password,username:username})}else iceServer={url:url,credential:password,username:username};return iceServer},createIceServers=function(urls,username,password){var iceServers=[];for(i=0;i<urls.length;i++){var iceServer=createIceServer(urls[i],username,password);null!==iceServer&&iceServers.push(iceServer)}return iceServers},attachMediaStream=function(element,stream){element.mozSrcObject=stream,element.play()},reattachMediaStream=function(to,from){to.mozSrcObject=from.mozSrcObject,to.play()},MediaStream.prototype.getVideoTracks||(MediaStream.prototype.getVideoTracks=function(){return[]}),MediaStream.prototype.getAudioTracks||(MediaStream.prototype.getAudioTracks=function(){return[]})}else if(navigator.webkitGetUserMedia){webrtcDetectedBrowser="chrome",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10),createIceServer=function(url,username,password){var iceServer=null,url_parts=url.split(":");return 0===url_parts[0].indexOf("stun")?iceServer={url:url}:0===url_parts[0].indexOf("turn")&&(iceServer={url:url,credential:password,username:username}),iceServer},createIceServers=function(urls,username,password){var iceServers=[];if(webrtcDetectedVersion>=34)iceServers={urls:urls,credential:password,username:username};else for(i=0;i<urls.length;i++){var iceServer=createIceServer(urls[i],username,password);null!==iceServer&&iceServers.push(iceServer)}return iceServers};var RTCPeerConnection=function(pcConfig,pcConstraints){return 34>webrtcDetectedVersion&&maybeFixConfiguration(pcConfig),new webkitRTCPeerConnection(pcConfig,pcConstraints)};getUserMedia=navigator.webkitGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,attachMediaStream=function(element,stream){"undefined"!=typeof element.srcObject?element.srcObject=stream:"undefined"!=typeof element.mozSrcObject?element.mozSrcObject=stream:"undefined"!=typeof element.src?element.src=URL.createObjectURL(stream):console.log("Error attaching stream to element.")},reattachMediaStream=function(to,from){to.src=from.src}}else console.log("Browser does not appear to be WebRTC-capable");module.exports.RTCPeerConnection=RTCPeerConnection,module.exports.getUserMedia=getUserMedia,module.exports.attachMediaStream=attachMediaStream,module.exports.reattachMediaStream=reattachMediaStream,module.exports.RTCSessionDescription=RTCSessionDescription,module.exports.RTCIceCandidate=RTCIceCandidate},{}]},{},[3]);