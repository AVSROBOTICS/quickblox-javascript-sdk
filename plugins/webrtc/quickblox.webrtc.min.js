(function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var j=typeof require=="function"&&require;if(!h&&j)return j(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}var f=typeof require=="function"&&require;for(var g=0;g<d.length;g++)e(d[g]);return e})({1:[function(a,b,c){var d={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:turnserver.quickblox.com:3478?transport=udp",username:"",credential:""},{urls:"turn:turnserver.quickblox.com:3478?transport=tcp",username:"",credential:""}]};b.exports=d},{}],2:[function(a,b,c){function e(a,b){var c=this;b&&(this._debug=b.debug||null,this._callbacks={onCallCallback:b.onCallCallback||null,onAcceptCallback:b.onAcceptCallback||null,onRejectCallback:b.onRejectCallback||null,onStopCallback:b.onStopCallback||null,onInnerAcceptCallback:null,onCandidateCallback:null}),this._onMessage=function(a){var b,e,g,h={};b=$(a).attr("from"),e=QBChatHelpers.getIDFromNode(b),g=$(a).find("extraParams")[0],$(g.childNodes).each(function(){h[$(this).context.tagName]=$(this).context.textContent});switch(h.videochat_signaling_type){case d.CALL:f("onCall from "+e),c._callbacks.onCallCallback(e,h);break;case d.ACCEPT:f("onAccept from "+e),c._callbacks.onAcceptCallback(e,h),c._callbacks.onInnerAcceptCallback(h.sdp);break;case d.REJECT:f("onReject from "+e),c._callbacks.onRejectCallback(e,h);break;case d.STOP:f("onStop from "+e),c._callbacks.onStopCallback(e,h);break;case d.CANDIDATE:c._callbacks.onCandidateCallback({sdpMLineIndex:h.sdpMLineIndex,candidate:h.candidate,sdpMid:h.sdpMid});break;case d.PARAMETERS_CHANGED:}return!0},this._sendMessage=function(b,c){var d,e;e={to:QBChatHelpers.getJID(b),from:a._connection.jid,type:"headline"},d=$msg(e).c("extraParams",{xmlns:Strophe.NS.CLIENT}),$(Object.keys(c)).each(function(){d.c(this).t(c[this]).up()}),a._connection.send(d)},a._connection.addHandler(c._onMessage,null,"message","headline")}function f(a){console.log("[qb_videochat_signalling]: "+a)}b.exports=e;var d={CALL:"qbvideochat_call",ACCEPT:"qbvideochat_acceptCall",REJECT:"qbvideochat_rejectCall",STOP:"qbvideochat_stopCall",CANDIDATE:"qbvideochat_candidate",PARAMETERS_CHANGED:"qbvideochat_callParametersChanged"};e.prototype.call=function(a,b,c,e){f("call to "+a),e=e||{},e.videochat_signaling_type=d.CALL,e.sessionID=c,e.sdp=b,e.platform="web",e.device_orientation="portrait",this._sendMessage(a,e)},e.prototype.accept=function(a,b,c,e){f("accept "+a),e=e||{},e.videochat_signaling_type=d.ACCEPT,e.sessionID=c,e.sdp=b,e.platform="web",e.device_orientation="portrait",this._sendMessage(a,e)},e.prototype.reject=function(a,b,c){f("reject "+a),c=c||{},c.videochat_signaling_type=d.REJECT,c.sessionID=b,this._sendMessage(a,c)},e.prototype.stop=function(a,b,c){f("stop "+a),c=c||{},c.videochat_signaling_type=d.STOP,c.sessionID=b,this._sendMessage(a,c)},e.prototype.sendCandidate=function(a,b,c){var e={videochat_signaling_type:d.CANDIDATE,sessionID:c,sdpMLineIndex:b.sdpMLineIndex,candidate:b.candidate,sdpMid:b.sdpMid};this._sendMessage(a,e)}},{}],3:[function(a,b,c){function k(a,b){var c=this;this.version="0.6.1",this.stopReason=j,this._state=i.INACTIVE,this._candidatesQueue=[],this.localStreamElement=null,this.remoteStreamElement=null,b&&(this._debug=b.debug||null,this.sessionID=b.sessionID||(new Date).getTime(),this.remoteSessionDescription=b.sessionDescription||null,this.constraints=b.constraints||null,l("sessionID "+this.sessionID),this._callbacks={onGetUserMediaSuccess:b.onGetUserMediaSuccess||null,onGetUserMediaError:b.onGetUserMediaError||null}),this.onAcceptSignalingCallback=function(a){c.setRemoteDescription(a,"answer")},this.addCandidate=function(a){var b;b=new d.RTCIceCandidate(a),c.pc.addIceCandidate(b)},this.signaling=a,this.signaling._callbacks.onInnerAcceptCallback=this.onAcceptSignalingCallback,this.signaling._callbacks.onCandidateCallback=this.addCandidate,this.getUserMedia=function(){function a(a){l("getUserMedia success"),c.localStream=a,c.createRTCPeerConnection(),c._callbacks.onGetUserMediaSuccess()}function b(a){l("getUserMedia error: "+JSON.stringify(a)),c._callbacks.onGetUserMediaError()}l("getUserMedia..."),d.getUserMedia(c.constraints,a,b)},this.attachMediaStream=function(a,b){d.attachMediaStream(a,b)},this.reattachMediaStream=function(a,b){d.reattachMediaStream(a,b)},this.createRTCPeerConnection=function(){l("RTCPeerConnection...");try{c.pc=new d.RTCPeerConnection(e,g),c.pc.addStream(c.localStream),c.pc.onicecandidate=c.onIceCandidateCallback,c.pc.onaddstream=c.onRemoteStreamAddedCallback,l("RTCPeerConnnection created")}catch(a){l("RTCPeerConnection failed: "+a.message)}},this.onIceCandidateCallback=function(a){var b=a.candidate;b&&(c._state==i.INACTIVE?c._candidatesQueue.push(b):c.signaling.sendCandidate(c.opponentID,b,c.sessionID))},this.onRemoteStreamAddedCallback=function(a){l("Remote stream added"),c.remoteStream=a.stream,c.attachMediaStream(c.remoteStreamElement,a.stream)},this.onGetSessionDescriptionSuccessCallback=function(a){l("LocalDescription..."),c.pc.setLocalDescription(a,function(){l("LocalDescription success"),c.localSessionDescription=a,a.type==="offer"?c.sendCallRequest():a.type==="answer"&&c.sendAceptRequest()},function(b){l("LocalDescription error: "+JSON.stringify(b))})},this.onCreateOfferFailureCallback=function(a){l("createOffer() error: "+JSON.stringify(a))},this.setRemoteDescription=function(a,b){l("RemoteDescription...");var e,f;c._state=i.ESTABLISHING,e=new d.RTCSessionDescription({sdp:a,type:b}),c.pc.setRemoteDescription(e,function(){l("RemoteDescription success"),e.type==="offer"&&c.pc.createAnswer(c.onGetSessionDescriptionSuccessCallback,c.onCreateAnswerFailureCallback,h)},function(b){l("RemoteDescription error: "+JSON.stringify(b))});for(var g=0;g<c._candidatesQueue.length;g++)f=c._candidatesQueue.pop(),c.signaling.sendCandidate(c.opponentID,f,c.sessionID)},this.onCreateAnswerFailureCallback=function(a){l("createAnswer() error: "+JSON.stringify(a))},this.sendCallRequest=function(){c.signaling.call(c.opponentID,c.localSessionDescription.sdp,c.sessionID,c.extraParams)},this.sendAceptRequest=function(){c.signaling.accept(c.opponentID,c.localSessionDescription.sdp,c.sessionID,c.extraParams)},this.hangup=function(){c._state=i.INACTIVE,c.signaling=null,c.localStream.stop(),c.pc.close(),c.pc=null}}function l(a){console.log("[qb_videochat]: "+a)}var d=a("../libs/adapter"),e=a("./config"),f=a("./qbSignaling");window.QBSignaling=f,window.QBVideoChat=k;var g={optional:[]},h={optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},i={INACTIVE:"inactive",ESTABLISHING:"establishing"},j={MANUALLY:"kStopVideoChatCallStatus_Manually",BAD_CONNECTION:"kStopVideoChatCallStatus_BadConnection",CANCEL:"kStopVideoChatCallStatus_Cancel",NOT_ANSWER:"kStopVideoChatCallStatus_OpponentDidNotAnswer"};k.prototype.call=function(a,b){this.localSessionDescription?this.sendCallRequest():(this.opponentID=a,this.extraParams=b,this.pc.createOffer(this.onGetSessionDescriptionSuccessCallback,this.onCreateOfferFailureCallback,h))},k.prototype.accept=function(a,b){this.opponentID=a,this.extraParams=b,this.setRemoteDescription(this.remoteSessionDescription,"offer")},k.prototype.reject=function(a,b){this.signaling.reject(a,this.sessionID,b)},k.prototype.stop=function(a,b){this.signaling.stop(a,this.sessionID,b)}},{"../libs/adapter":4,"./config":1,"./qbSignaling":2}],4:[function(a,b,c){function k(a){a[a.length-1]=="\n"&&(a=a.substring(0,a.length-1)),console.log((performance.now()/1e3).toFixed(3)+": "+a)}function l(a){if(a==null)return;for(var b=0;b<a.iceServers.length;b++)a.iceServers[b].hasOwnProperty("urls")&&(a.iceServers[b].url=a.iceServers[b].urls,delete a.iceServers[b].urls)}var d=null,e=null,f=null,g=null,h=null,j=null;if(navigator.mozGetUserMedia){h="firefox",j=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10);var d=function(a,b){return l(a),new mozRTCPeerConnection(a,b)};RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,e=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=e,createIceServer=function(a,b,c){var d=null,e=a.split(":");if(e[0].indexOf("stun")===0)d={url:a};else if(e[0].indexOf("turn")===0)if(j<27){var f=a.split("?");if(f.length===1||f[1].indexOf("transport=udp")===0)d={url:f[0],credential:c,username:b}}else d={url:a,credential:c,username:b};return d},createIceServers=function(a,b,c){var d=[];for(i=0;i<a.length;i++){var e=createIceServer(a[i],b,c);e!==null&&d.push(e)}return d},f=function(a,b){a.mozSrcObject=b,a.play()},g=function(a,b){a.mozSrcObject=b.mozSrcObject,a.play()},MediaStream.prototype.getVideoTracks||(MediaStream.prototype.getVideoTracks=function(){return[]}),MediaStream.prototype.getAudioTracks||(MediaStream.prototype.getAudioTracks=function(){return[]})}else if(navigator.webkitGetUserMedia){h="chrome",j=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10),createIceServer=function(a,b,c){var d=null,e=a.split(":");return e[0].indexOf("stun")===0?d={url:a}:e[0].indexOf("turn")===0&&(d={url:a,credential:c,username:b}),d},createIceServers=function(a,b,c){var d=[];if(j>=34)d={urls:a,credential:c,username:b};else for(i=0;i<a.length;i++){var e=createIceServer(a[i],b,c);e!==null&&d.push(e)}return d};var d=function(a,b){return j<34&&l(a),new webkitRTCPeerConnection(a,b)};e=navigator.webkitGetUserMedia.bind(navigator),navigator.getUserMedia=e,f=function(a,b){typeof a.srcObject!="undefined"?a.srcObject=b:typeof a.mozSrcObject!="undefined"?a.mozSrcObject=b:typeof a.src!="undefined"?a.src=URL.createObjectURL(b):console.log("Error attaching stream to element.")},g=function(a,b){a.src=b.src}}else console.log("Browser does not appear to be WebRTC-capable");b.exports.RTCPeerConnection=d,b.exports.getUserMedia=e,b.exports.attachMediaStream=f,b.exports.reattachMediaStream=g,b.exports.RTCSessionDescription=RTCSessionDescription,b.exports.RTCIceCandidate=RTCIceCandidate},{}]},{},[3]);